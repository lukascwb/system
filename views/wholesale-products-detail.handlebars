<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wholesale Products Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .zoom {
            transition: transform .2s;
            cursor: pointer;
        }
        .zoom:hover {
            transform: scale(8);
            position: absolute;
            transform-origin: center center;
            z-index: 1000;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Smart positioning for zoomed images to prevent overflow */
        .zoom:hover {
            /* Check if image would overflow right edge */
            left: auto !important;
            right: auto !important;
        }

        /* For images in the first column (left side) */
        .col-md-2 .zoom:hover,
        .col-3 .zoom:hover {
            left: 0 !important;
            transform-origin: left center;
        }

        /* For images in the last column (right side) */
        .col-md-3 .zoom:hover {
            right: 0 !important;
            transform-origin: right center;
        }

        /* For images in middle columns, center them */
        .col-md-7 .zoom:hover,
        .col-9 .zoom:hover {
            left: 50% !important;
            transform: translateX(-50%) scale(6);
            transform-origin: center center;
        }

        /* Fix for Amazon items - ensure each item's zoom is independent */
        .amazon-item .zoom:hover {
            position: absolute;
            z-index: 1001; /* Higher than other zoomed images */
        }

        /* Ensure Amazon thumbnails have proper positioning context */
        .amazon-item {
            position: relative;
        }

        /* Specific positioning for Amazon thumbnails */
        .amazon-item .col-3 .zoom:hover {
            left: 0 !important;
            transform-origin: left center;
        }

        /* Ensure wholesale items don't interfere with Amazon items */
        .product-header .zoom:hover {
            z-index: 1002; /* Higher than Amazon items */
        }
        .wholesale-thumbnail {
            max-width: 120px;
            max-height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        .amazon-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .product-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .product-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        .product-body {
            padding: 20px;
        }
        .amazon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        /* When there are 2 or fewer Amazon results, show 2 per line */
        .amazon-grid.few-results {
            grid-template-columns: repeat(2, 1fr);
        }
        .amazon-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #28a745;
            transition: transform 0.2s;
        }
        .amazon-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .price-highlight {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }
        .profit-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
        }
        .status-approved {
            color: #28a745;
        }
        .status-rejected {
            color: #dc3545;
        }
        .status-warning {
            color: #ffc107;
        }
        .product-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .product-meta {
            font-size: 0.9em;
            color: #6c757d;
        }
        .search-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        /* Compact grid for products with no Amazon results */
        .no-results-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
        }
        
        .wholesale-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .wholesale-compact-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #ffc107;
            transition: transform 0.2s;
        }
        
        .wholesale-compact-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
                         .wholesale-compact-item .wholesale-thumbnail {
            max-width: 80px;
            max-height: 80px;
        }

        /* Grid layout for wholesale products with Amazon results */
        .wholesale-products-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Products with 3+ Amazon results get full width (alone on line) */
        .product-card {
            grid-column: span 1;
        }

        /* Products with 0-2 Amazon results can share a line */
        .product-card.few-amazon-results {
            grid-column: span 1;
        }

        /* Responsive grid adjustments */
        @media (min-width: 768px) {
            .wholesale-products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Products with 3+ Amazon results get full width (span 2 columns) */
            .product-card {
                grid-column: span 2;
            }
            
            /* Products with 0-2 Amazon results share a line (span 1 column) */
            .product-card.few-amazon-results {
                grid-column: span 1;
            }
        }

        @media (min-width: 1200px) {
            .wholesale-products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Special layout for products with very few Amazon results */
        .product-card.few-amazon-results .product-body {
            padding: 15px;
        }

        .product-card.few-amazon-results .amazon-grid {
            margin-top: 10px;
        }
         
         /* Tooltip styling */
         .tooltip {
             font-size: 0.875rem;
         }
         
         .tooltip-inner {
             max-width: 300px;
             text-align: left;
             background-color: #e3f2fd;
             color: #000;
             border: 1px solid #2196f3;
             border-radius: 6px;
             padding: 8px 12px;
         }
         
         .tooltip.bs-tooltip-top .tooltip-arrow::before {
             border-top-color: #2196f3;
         }
         
         .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
             border-bottom-color: #2196f3;
         }
         
         .tooltip.bs-tooltip-start .tooltip-arrow::before {
             border-left-color: #2196f3;
         }
         
         .tooltip.bs-tooltip-end .tooltip-arrow::before {
             border-right-color: #2196f3;
         }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-boxes me-2"></i>Wholesale Batch: {{wholesale_id}}</h2>
                        {{#if totalLoadTime}}
                            <div class="text-center mt-2">
                                <span class="badge bg-info">
                                    <i class="fas fa-clock me-1"></i>Total page load time: {{totalLoadTime}} seconds
                                </span>
                            </div>
                        {{/if}}
                        {{#if wholesaleProductsWithResults}}
                            <div class="mt-2">
                                {{#with (lookup wholesaleProductsWithResults 0)}}
                                    {{#if amazonResults.[0].from_cache}}
                                        <span class="badge bg-info me-2">
                                            <i class="fas fa-database me-1"></i>Using cached data (1-month policy)
                                        </span>
                                    {{else}}
                                        <span class="badge bg-success me-2">
                                            <i class="fas fa-sync-alt me-1"></i>Fresh data from API
                                        </span>
                                    {{/if}}
                                {{/with}}
                            </div>
                        {{/if}}
                    </div>
                                         <div class="d-flex gap-2">
                         <button class="btn btn-outline-info btn-sm" 
                                 data-bs-toggle="tooltip" 
                                 data-bs-html="true"
                                 title="<strong>Tooltip Test:</strong><br>If you can see this, tooltips are working! 🎉">
                             <i class="fas fa-info-circle me-1"></i>Test Tooltip
                         </button>
                         <a href="/wholesale-list" class="btn btn-outline-secondary">
                             <i class="fas fa-arrow-left me-2"></i>Back to List
                         </a>
                     </div>
                </div>

                {{#if message}}
                    <div class="alert alert-info">{{message}}</div>
                {{/if}}



    <!-- Wholesale Products List -->
                    {{#if wholesaleProductsWithResults}}
                    {{!-- First: Show products with Amazon results --}}
                    <div class="wholesale-products-grid">
                        {{#each wholesaleProductsWithResults}}
                            {{#if this.amazonResults.length}}
                                <div class="product-card {{#if (lte this.amazonResults.length 2)}}few-amazon-results{{/if}}">
                                {{!-- Wholesale Product Header --}}
                                <div class="product-header">
                                    <div class="row align-items-center">
                                        <div class="col-md-2">
                                            {{#if this.wholesaleProduct.thumbnail}}
                                                <img src="{{this.wholesaleProduct.thumbnail}}" 
                                                     alt="Wholesale Product" 
                                                     class="wholesale-thumbnail zoom"
                                                     title="Click to enlarge">
                                            {{else}}
                                                <div class="wholesale-thumbnail bg-light d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-image text-muted" style="font-size: 2em;"></i>
                                                </div>
                                            {{/if}}
                                        </div>
                                        <div class="col-md-7">
                                            <h4 class="mb-2">
                                                {{this.wholesaleProduct.title}}
                                                {{#if this.amazonResults.[0].from_cache}}
                                                    <span class="badge bg-info ms-2" title="Data from cache (last updated within 1 month)">
                                                        <i class="fas fa-database me-1"></i>Cached
                                                    </span>
                                                {{else}}
                                                    <span class="badge bg-success ms-2" title="Fresh data from API">
                                                        <i class="fas fa-sync-alt me-1"></i>Fresh
                                                    </span>
                                                {{/if}}
                                            </h4>
                                            <div class="row">
                                                {{#if this.wholesaleProduct.brand}}
                                                    <div class="col-md-4">
                                                        <small><i class="fas fa-tag me-1"></i><strong>Brand:</strong> {{this.wholesaleProduct.brand}}</small>
                                                    </div>
                                                {{/if}}
                                                {{#if this.wholesaleProduct.size}}
                                                    <div class="col-md-4">
                                                        <small><i class="fas fa-ruler me-1"></i><strong>Size:</strong> {{this.wholesaleProduct.size}}</small>
                                                    </div>
                                                {{/if}}
                                                {{#if this.wholesaleProduct.item}}
                                                    <div class="col-md-4">
                                                        <small><i class="fas fa-barcode me-1"></i><strong>SKU:</strong> {{this.wholesaleProduct.item}}</small>
                                                    </div>
                                                {{/if}}
                                            </div>
                                            {{#if this.wholesaleProduct.packSize}}
                                                <small><i class="fas fa-box me-1"></i><strong>Pack:</strong> {{this.wholesaleProduct.packSize}}</small>
                                            {{/if}}
                                            {{#if this.wholesaleProduct.qty}}
                                                <small class="ms-3"><i class="fas fa-layer-group me-1"></i><strong>Qty:</strong> {{this.wholesaleProduct.qty}}</small>
                                            {{/if}}
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <div class="price-highlight" 
                                                 data-bs-toggle="tooltip" 
                                                 data-bs-html="true"
                                                 title="<strong>Wholesale Cost Details:</strong><br>
                                                 <div style='text-align: left;'>
                                                 <strong>Original Cost:</strong> ${{formatNumber this.wholesaleProduct.wholesaleCost 2}}<br>
                                                 {{#if (gt (lookup this.amazonResults 0 'analysis.adjustedWholesaleCost') (lookup this.amazonResults 0 'analysis.originalWholesaleCost'))}}
                                                 <strong>Adjusted Cost:</strong> ${{formatNumber (lookup this.amazonResults 0 'analysis.adjustedWholesaleCost') 2}}<br>
                                                 <small>(Package adjustment applied)</small>
                                                 {{/if}}
                                                 </div>">
                                                ${{formatNumber this.wholesaleProduct.wholesaleCost 2}}
                                            </div>
                                            <small>Wholesale Cost</small>
                                            <div class="mt-2 d-flex flex-column gap-1">
                                                {{#if this.wholesaleProduct.hyperlink}}
                                                    <a href="{{this.wholesaleProduct.hyperlink}}" target="_blank" class="btn btn-sm btn-light">
                                                        <i class="fas fa-external-link-alt me-1"></i>View Store
                                                    </a>
                                                {{/if}}
                                                <button class="btn btn-sm btn-info" onclick="fetchSearchApiJsonData('{{this.wholesaleProduct.id}}')">
                                                    <i class="fas fa-code me-1"></i>JSON Data
                                                </button>
                                                <button class="btn btn-sm btn-warning" onclick="fetchSearchApiHtmlData('{{this.wholesaleProduct.id}}')">
                                                    <i class="fas fa-search me-1"></i>Amazon Search
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {{!-- Amazon Results Section --}}
                                <div class="product-body">
                                    <div class="amazon-grid {{#if (lte this.amazonResults.length 2)}}few-results{{/if}}">
                                        {{#each this.amazonResults}}
                                            <div class="amazon-item">
                                                <div class="row">
                                                    <div class="col-3">
                                                        {{#if this.thumbnail}}
                                                            <img src="{{this.thumbnail}}" 
                                                                 alt="Amazon Product" 
                                                                 class="amazon-thumbnail zoom"
                                                                 title="Hover to enlarge">
                                                        {{else}}
                                                            <div class="amazon-thumbnail bg-light d-flex align-items-center justify-content-center">
                                                                <i class="fas fa-image text-muted"></i>
                                                            </div>
                                                        {{/if}}
                                                    </div>
                                                    <div class="col-9">
                                                        <div class="product-title">{{this.title}}</div>
                                                        <div class="product-meta">
                                                            {{#if this.brand}}
                                                                <div><i class="fas fa-tag me-1"></i>{{this.brand}}</div>
                                                            {{/if}}
                                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                                <span class="price-highlight"
                                                                      data-bs-toggle="tooltip" 
                                                                      data-bs-html="true"
                                                                                                                                             title="<strong>Amazon Price Details:</strong><br>
                                                                       <div style='text-align: left;'>
                                                                       {{#if this.analysis}}
                                                                       <strong>Current Price:</strong> ${{formatNumber this.analysis.price 2}}<br>
                                                                       {{#if this.analysis.deliveryInfo}}
                                                                       <strong>Delivery:</strong> {{this.analysis.deliveryInfo.text}}<br>
                                                                       {{/if}}
                                                                       <strong>Seller:</strong> {{this.seller}}<br>
                                                                       <strong>Rating:</strong> {{this.rating}} ⭐<br>
                                                                       <strong>Reviews:</strong> {{this.reviews}}<br>
                                                                       {{#if this.recent_sales}}
                                                                       <strong>Recent Sales:</strong> {{this.recent_sales}}
                                                                       {{/if}}
                                                                       {{else}}
                                                                      <strong>Price Source:</strong> {{#if (lookup this 'extracted_price')}}Extracted{{else}}Raw{{/if}}<br>
                                                                      <strong>Seller:</strong> {{this.seller}}
                                                                      {{/if}}
                                                                      </div>">
                                                                                                                                         {{#if this.analysis}}
                                                                         {{#if this.analysis.price}}
                                                                             ${{formatNumber this.analysis.price 2}}
                                                                             {{#if this.analysis.deliveryInfo}}
                                                                                 <br><small class="text-info">
                                                                                     <i class="fas fa-shipping-fast me-1"></i>
                                                                                     {{this.analysis.deliveryInfo.text}}
                                                                                 </small>
                                                                             {{/if}}
                                                                         {{else}}
                                                                             <span class="text-muted">Price not available</span>
                                                                         {{/if}}
                                                                     {{else}}
                                                                        {{#if this.price}}
                                                                            {{#if (eq this.price "No Amazon results found for this product.")}}
                                                                                <span class="text-muted">Price not available</span>
                                                                            {{else}}
                                                                                {{#if (lookup this 'extracted_price')}}
                                                                                    ${{formatNumber this.extracted_price 2}}
                                                                                {{else if (lookup this 'more_offers')}}
                                                                                    {{#if this.more_offers.extracted_lowest_price}}
                                                                                        ${{formatNumber this.more_offers.extracted_lowest_price 2}}
                                                                                    {{else if this.more_offers.lowest_price}}
                                                                                        {{this.more_offers.lowest_price}}
                                                                                    {{else}}
                                                                                        {{this.price}}
                                                                                    {{/if}}
                                                                                {{else}}
                                                                                    {{this.price}}
                                                                                {{/if}}
                                                                            {{/if}}
                                                                        {{else}}
                                                                            <span class="text-muted">Price not available</span>
                                                                        {{/if}}
                                                                    {{/if}}
                                                                </span>
                                                                {{#if this.analysis}}
                                                                    <div class="d-flex flex-column gap-1">
                                                                        <span class="profit-badge bg-{{#if (gt this.analysis.profit 0)}}success{{else}}danger{{/if}} text-white"
                                                                              data-bs-toggle="tooltip" 
                                                                              data-bs-html="true"
                                                                                                                                                             title="<strong>Cost Breakdown:</strong><br>
                                                                               <div style='text-align: left;'>
                                                                               <strong>Amazon Sell Price:</strong> ${{formatNumber this.analysis.price 2}}<br>
                                                                               {{#if this.analysis.deliveryInfo}}
                                                                               <strong>Delivery Cost:</strong> ${{formatNumber this.analysis.deliveryInfo.cost 2}}<br>
                                                                               {{/if}}
                                                                               <strong>Wholesale Cost:</strong> ${{formatNumber this.analysis.adjustedWholesaleCost 2}}<br>
                                                                               <strong>Amazon Fee (15%):</strong> ${{formatNumber this.analysis.amazonFee 2}}<br>
                                                                               <strong>Shipping:</strong> $6.00<br>
                                                                               <strong>Total Costs:</strong> ${{formatNumber this.analysis.totalCosts 2}}<br>
                                                                               <strong>Profit:</strong> ${{formatNumber this.analysis.profit 2}}<br>
                                                                               <strong>Profit Margin:</strong> {{formatNumber this.analysis.margin 1}}%
                                                                              {{#if this.analysis.costAdjustmentReason}}
                                                                              <br><br><strong>Cost Adjustment:</strong><br>
                                                                              <small>{{this.analysis.costAdjustmentReason}}</small>
                                                                              {{/if}}
                                                                              </div>">
                                                                            {{#if this.analysis.profit}}
                                                                                ${{formatNumber this.analysis.profit 2}} profit
                                                                            {{else}}
                                                                                No profit data
                                                                            {{/if}}
                                                                        </span>
                                                                                                                                                 {{#if this.analysis.geminiMatch}}
                                                                             <span class="badge bg-success text-white gemini-match-badge" style="font-size: 0.7em;" 
                                                                                   data-bs-toggle="tooltip" 
                                                                                   data-bs-html="true"
                                                                                   title="<strong>AI Analysis:</strong><br>Match: ✅ Yes<br>Confidence Score: {{this.analysis.geminiConfidenceScore}}/10<br>Brand Match: {{#if this.analysis.brandMatch}}✅{{else}}❌{{/if}}<br>Title Similarity: {{this.analysis.titleSimilarity}}<br>Reason: {{this.analysis.geminiReason}}{{#if this.analysis.from_cache}}<br><br><strong>Source:</strong> Cached AI Analysis{{else}}<br><br><strong>Source:</strong> Fresh AI Analysis{{/if}}">
                                                                                   <i class="fas fa-robot me-1"></i>AI Match ({{this.analysis.geminiConfidenceScore}}/10){{#if this.analysis.from_cache}}<i class="fas fa-database ms-1" title="Cached"></i>{{/if}}
                                                                             </span>
                                                                         {{else}}
                                                                             <span class="badge bg-warning text-dark gemini-match-badge" style="font-size: 0.7em;"
                                                                                   data-bs-toggle="tooltip" 
                                                                                   data-bs-html="true"
                                                                                   title="<strong>AI Analysis:</strong><br>Match: ❌ No<br>Confidence Score: {{this.analysis.geminiConfidenceScore}}/10<br>Brand Match: {{#if this.analysis.brandMatch}}✅{{else}}❌{{/if}}<br>Title Similarity: {{this.analysis.titleSimilarity}}<br>Reason: {{this.analysis.geminiReason}}{{#if this.analysis.from_cache}}<br><br><strong>Source:</strong> Cached AI Analysis{{else}}<br><br><strong>Source:</strong> Fresh AI Analysis{{/if}}">
                                                                                   <i class="fas fa-exclamation-triangle me-1"></i>No Match{{#if this.analysis.from_cache}}<i class="fas fa-database ms-1" title="Cached"></i>{{/if}}
                                                                             </span>
                                                                         {{/if}}
                                                                        {{#if this.analysis.packageInfo.isPackage}}
                                                                            <span class="badge bg-info text-white package-badge" style="font-size: 0.7em;"
                                                                                  data-bs-toggle="tooltip" 
                                                                                  data-bs-html="true"
                                                                                  title="<strong>Package Detection:</strong><br>Quantity: {{this.analysis.packageInfo.quantity}} {{this.analysis.packageInfo.packageType}}<br>Confidence: {{this.analysis.packageInfo.confidence}}<br>Reason: {{this.analysis.packageInfo.reason}}<br><br><strong>Cost Adjustment:</strong><br>Original: ${{formatNumber this.analysis.originalWholesaleCost 2}}<br>Adjusted: ${{formatNumber this.analysis.adjustedWholesaleCost 2}}">
                                                                                  <i class="fas fa-box me-1"></i>{{this.analysis.packageInfo.quantity}} {{this.analysis.packageInfo.packageType}}
                                                                            </span>
                                                                        {{/if}}
                                                                    </div>
                                                                {{/if}}
                                                            </div>
                                                            <div class="d-flex justify-content-between align-items-center mt-1">
                                                                {{#if this.rating}}
                                                                    <small><i class="fas fa-star text-warning me-1"></i>{{this.rating}}</small>
                                                                {{/if}}
                                                                {{#if this.reviews}}
                                                                    <small><i class="fas fa-comments me-1"></i>{{this.reviews}} reviews</small>
                                                                {{/if}}
                                                                {{#if this.seller}}
                                                                    <small><i class="fas fa-store me-1"></i>{{this.seller}}</small>
                                                                {{/if}}
                                                            </div>
                                                            {{#if this.link}}
                                                                <div class="mt-2">
                                                                    <a href="{{this.link}}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                                        <i class="fas fa-external-link-alt me-1"></i>View on Amazon
                                                                    </a>
                                                                </div>
                                                            {{else if this.asin}}
                                                                <div class="mt-2">
                                                                    <a href="https://www.amazon.com/dp/{{this.asin}}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                                        <i class="fas fa-external-link-alt me-1"></i>View on Amazon
                                                                    </a>
                                                                </div>
                                                            {{/if}}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {{/each}}
                                    </div>
                                </div>
                            </div>
                        {{/if}}
                    {{/each}}
                    </div>

                    {{!-- Second: Show products with NO Amazon results in a compact grid --}}
                    <div class="no-results-section">
                        <h4 class="mb-3"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Products with No Amazon Results</h4>
                        <div class="wholesale-grid">
                            {{#each wholesaleProductsWithResults}}
                                {{#unless this.amazonResults.length}}
                                    <div class="wholesale-compact-item">
                                        <div class="row align-items-center">
                                            <div class="col-md-2">
                                                {{#if this.wholesaleProduct.thumbnail}}
                                                    <img src="{{this.wholesaleProduct.thumbnail}}" 
                                                         alt="Wholesale Product" 
                                                         class="wholesale-thumbnail zoom"
                                                         title="Click to enlarge">
                                                {{else}}
                                                    <div class="wholesale-thumbnail bg-light d-flex align-items-center justify-content-center">
                                                        <i class="fas fa-image text-muted" style="font-size: 2em;"></i>
                                                    </div>
                                                {{/if}}
                                            </div>
                                            <div class="col-md-7">
                                                <h5 class="mb-1">{{this.wholesaleProduct.title}}</h5>
                                                <div class="row">
                                                    {{#if this.wholesaleProduct.brand}}
                                                        <div class="col-md-4">
                                                            <small><i class="fas fa-tag me-1"></i><strong>Brand:</strong> {{this.wholesaleProduct.brand}}</small>
                                                        </div>
                                                    {{/if}}
                                                    {{#if this.wholesaleProduct.size}}
                                                        <div class="col-md-4">
                                                            <small><i class="fas fa-ruler me-1"></i><strong>Size:</strong> {{this.wholesaleProduct.size}}</small>
                                                        </div>
                                                    {{/if}}
                                                    {{#if this.wholesaleProduct.item}}
                                                        <div class="col-md-4">
                                                            <small><i class="fas fa-barcode me-1"></i><strong>SKU:</strong> {{this.wholesaleProduct.item}}</small>
                                                        </div>
                                                    {{/if}}
                                                </div>
                                            </div>
                                            <div class="col-md-3 text-end">
                                                <div class="price-highlight">${{formatNumber this.wholesaleProduct.wholesaleCost 2}}</div>
                                                <small>Wholesale Cost</small>
                                                <div class="mt-2 d-flex flex-column gap-1">
                                                    {{#if this.wholesaleProduct.hyperlink}}
                                                        <a href="{{this.wholesaleProduct.hyperlink}}" target="_blank" class="btn btn-sm btn-light">
                                                            <i class="fas fa-external-link-alt me-1"></i>View Store
                                                        </a>
                                                    {{/if}}
                                                    <button class="btn btn-sm btn-info" onclick="fetchSearchApiJsonData('{{this.wholesaleProduct.id}}')">
                                                        <i class="fas fa-code me-1"></i>JSON Data
                                                    </button>
                                                    <button class="btn btn-sm btn-warning" onclick="fetchSearchApiHtmlData('{{this.wholesaleProduct.id}}')">
                                                        <i class="fas fa-search me-1"></i>Amazon Search
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {{/unless}}
                            {{/each}}
                        </div>
                    </div>

                    {{!-- Pagination --}}
                    {{#if (gt wholesaleTotalPages 1)}}
                        <nav aria-label="Wholesale products pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                {{#if (gt wholesaleCurrentPage 1)}}
                                    <li class="page-item">
                                        <a class="page-link" href="{{wholesalePageUrl}}{{dec wholesaleCurrentPage}}" onclick="console.log('Previous page clicked:', '{{wholesalePageUrl}}{{dec wholesaleCurrentPage}}')">
                                            <i class="fas fa-chevron-left"></i> Previous
                                        </a>
                                    </li>
                                {{/if}}
                                
                                {{#each (range wholesaleStartPage wholesaleEndPage)}}
                                    <li class="page-item {{#if (eq this ../wholesaleCurrentPage)}}active{{/if}}">
                                        <a class="page-link" href="{{../wholesalePageUrl}}{{this}}" onclick="console.log('Page {{this}} clicked:', '{{../wholesalePageUrl}}{{this}}')">{{this}}</a>
                                    </li>
                                {{/each}}
                                
                                {{#if (lt wholesaleCurrentPage wholesaleTotalPages)}}
                                    <li class="page-item">
                                        <a class="page-link" href="{{wholesalePageUrl}}{{inc wholesaleCurrentPage}}" onclick="console.log('Next page clicked:', '{{wholesalePageUrl}}{{inc wholesaleCurrentPage}}')">
                                            Next <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {{/if}}
                            </ul>
                        </nav>
                        
                        <!-- Debug info -->
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                Debug: Page {{wholesaleCurrentPage}} of {{wholesaleTotalPages}} | 
                                URL: {{wholesalePageUrl}} | 
                                Wholesale ID: {{wholesale_id}}
                            </small>
                        </div>
                    {{/if}}
                {{else}}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    No wholesale products found for this batch.
                </div>
            {{/if}}
            </div>
        </div>
    </div>

         <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
     <script>
         // Initialize Bootstrap tooltips
         document.addEventListener('DOMContentLoaded', function() {
             // Initialize all tooltips
             var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
             var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                 return new bootstrap.Tooltip(tooltipTriggerEl, {
                     html: true,
                     placement: 'top',
                     trigger: 'hover focus'
                 });
             });
             
             console.log(`Initialized ${tooltipList.length} tooltips`);
         });
         
         // Function to reinitialize tooltips after dynamic content is loaded
         function reinitializeTooltips() {
             // Destroy existing tooltips first
             var existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
             existingTooltips.forEach(function(element) {
                 var tooltip = bootstrap.Tooltip.getInstance(element);
                 if (tooltip) {
                     tooltip.dispose();
                 }
             });
             
             // Initialize new tooltips
             var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
             var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                 return new bootstrap.Tooltip(tooltipTriggerEl, {
                     html: true,
                     placement: 'top',
                     trigger: 'hover focus'
                 });
             });
             
             console.log(`Reinitialized ${tooltipList.length} tooltips`);
         }

        // Function to fetch and display SearchAPI JSON data
        async function fetchSearchApiJsonData(productId) {
            const modalElement = document.getElementById('searchApiJsonModal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Reset modal state completely
            document.getElementById('searchApiJsonModalTitle').textContent = `SearchAPI JSON Data - Product ID: ${productId}`;
            document.getElementById('searchApiJsonLoading').style.display = 'block';
            document.getElementById('searchApiJsonContent').style.display = 'none';
            document.getElementById('searchApiJsonError').style.display = 'none';
            document.getElementById('searchApiJsonMetadata').textContent = '';
            document.getElementById('searchApiJsonBody').textContent = '';
            
            modal.show();
            
            try {
                console.log(`Fetching JSON data for product ID: ${productId}`);
                
                // Add a small delay to prevent rapid successive calls
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const response = await fetch(`/api/wholesale/searchapi-json/${productId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    cache: 'no-cache', // Prevent caching issues
                    credentials: 'same-origin' // Include cookies for authentication
                });
                
                console.log(`Response status: ${response.status}`);
                console.log(`Response headers:`, response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`HTTP error response: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Response result:', result);
                
                if (result.success) {
                    // Hide loading, show content
                    document.getElementById('searchApiJsonLoading').style.display = 'none';
                    document.getElementById('searchApiJsonContent').style.display = 'block';
                    
                    // Show cache status in title
                    const cacheStatus = result.from_cache ? ' (Cached Data)' : ' (Fresh Data)';
                    document.getElementById('searchApiJsonModalTitle').textContent = `SearchAPI JSON Data - Product ID: ${productId}${cacheStatus}`;
                    
                    // Display metadata
                    document.getElementById('searchApiJsonMetadata').textContent = JSON.stringify(result.searchMetadata, null, 2);
                    
                    // Display full JSON data
                    document.getElementById('searchApiJsonBody').textContent = JSON.stringify(result.data, null, 2);
                } else {
                    throw new Error(result.error || 'Failed to fetch JSON data');
                }
            } catch (error) {
                console.error('Error fetching SearchAPI JSON data:', error);
                document.getElementById('searchApiJsonLoading').style.display = 'none';
                document.getElementById('searchApiJsonError').style.display = 'block';
                document.getElementById('searchApiJsonError').textContent = `Error: ${error.message}`;
            }
        }

        // Function to fetch and display SearchAPI HTML data
        async function fetchSearchApiHtmlData(productId) {
            const modalElement = document.getElementById('searchApiHtmlModal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Reset modal state completely
            document.getElementById('searchApiHtmlModalTitle').textContent = `SearchAPI HTML Data - Product ID: ${productId}`;
            document.getElementById('searchApiHtmlLoading').style.display = 'block';
            document.getElementById('searchApiHtmlContent').style.display = 'none';
            document.getElementById('searchApiHtmlError').style.display = 'none';
            document.getElementById('searchApiHtmlMetadata').textContent = '';
            document.getElementById('searchApiHtmlBody').innerHTML = '';
            
            modal.show();
            
            try {
                console.log(`Fetching HTML data for product ID: ${productId}`);
                const response = await fetch(`/api/wholesale/searchapi-html/${productId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    cache: 'no-cache' // Prevent caching issues
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Hide loading, show content
                    document.getElementById('searchApiHtmlLoading').style.display = 'none';
                    document.getElementById('searchApiHtmlContent').style.display = 'block';
                    
                    // Show cache status in title
                    const cacheStatus = result.from_cache ? ' (Cached Data)' : ' (Fresh Data)';
                    document.getElementById('searchApiHtmlModalTitle').textContent = `SearchAPI HTML Data - Product ID: ${productId}${cacheStatus}`;
                    
                    // Display metadata
                    document.getElementById('searchApiHtmlMetadata').textContent = JSON.stringify(result.searchMetadata, null, 2);
                    
                    // Display HTML data
                    document.getElementById('searchApiHtmlBody').innerHTML = result.data;
                } else {
                    throw new Error(result.error || 'Failed to fetch HTML data');
                }
            } catch (error) {
                console.error('Error fetching SearchAPI HTML data:', error);
                document.getElementById('searchApiHtmlLoading').style.display = 'none';
                document.getElementById('searchApiHtmlError').style.display = 'block';
                document.getElementById('searchApiHtmlError').textContent = `Error: ${error.message}`;
            }
        }
    </script>

    <!-- SearchAPI JSON Data Modal -->
    <div class="modal fade" id="searchApiJsonModal" tabindex="-1" aria-labelledby="searchApiJsonModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-lg-down" style="max-width: 95%; width: 95%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchApiJsonModalTitle">SearchAPI JSON Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="searchApiJsonLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Fetching SearchAPI JSON data...</p>
                    </div>
                    <div id="searchApiJsonContent" style="display: none;">
                        <div class="mb-3">
                            <h6>Search Metadata:</h6>
                            <pre id="searchApiJsonMetadata" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 0.9em; max-height: 200px; overflow-y: auto;"></pre>
                        </div>
                        <div>
                            <h6>Full JSON Response:</h6>
                            <pre id="searchApiJsonBody" style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-size: 0.8em;"></pre>
                        </div>
                    </div>
                    <div id="searchApiJsonError" class="alert alert-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="copyToClipboard('searchApiJsonBody')">
                        <i class="fas fa-copy me-1"></i>Copy JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SearchAPI HTML Data Modal -->
    <div class="modal fade" id="searchApiHtmlModal" tabindex="-1" aria-labelledby="searchApiHtmlModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-lg-down" style="max-width: 95%; width: 95%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchApiHtmlModalTitle">SearchAPI HTML Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="searchApiHtmlLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Fetching SearchAPI HTML data...</p>
                    </div>
                    <div id="searchApiHtmlContent" style="display: none;">
                        <div class="mb-3">
                            <h6>Search Metadata:</h6>
                            <pre id="searchApiHtmlMetadata" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 0.9em; max-height: 200px; overflow-y: auto;"></pre>
                        </div>
                        <div>
                            <h6>HTML Response:</h6>
                            <div id="searchApiHtmlBody" style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6;"></div>
                        </div>
                    </div>
                    <div id="searchApiHtmlError" class="alert alert-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="copyToClipboard('searchApiHtmlBody')">
                        <i class="fas fa-copy me-1"></i>Copy HTML
                    </button>
                    <button type="button" class="btn btn-info" onclick="downloadHtmlData()">
                        <i class="fas fa-download me-1"></i>Download HTML
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to copy text to clipboard
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            let text;
            
            // Handle different types of elements
            if (elementId === 'searchApiHtmlBody') {
                text = element.innerHTML;
            } else {
                text = element.textContent || element.href;
            }
            
            navigator.clipboard.writeText(text).then(function() {
                // Show a temporary success message
                const originalText = event.target.innerHTML;
                event.target.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                event.target.classList.remove('btn-primary', 'btn-warning', 'btn-info');
                event.target.classList.add('btn-success');
                
                setTimeout(function() {
                    event.target.innerHTML = originalText;
                    event.target.classList.remove('btn-success');
                    if (originalText.includes('Copy JSON')) {
                        event.target.classList.add('btn-primary');
                    } else if (originalText.includes('Copy HTML')) {
                        event.target.classList.add('btn-warning');
                    } else {
                        event.target.classList.add('btn-info');
                    }
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
            });
        }

        // Function to download HTML data
        function downloadHtmlData() {
            const htmlContent = document.getElementById('searchApiHtmlBody').innerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'searchapi-html-data.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>